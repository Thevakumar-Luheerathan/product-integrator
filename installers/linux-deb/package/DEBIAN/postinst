#!/usr/bin/env bash

# Symlink bin command to /usr/bin
rm -f /usr/bin/wso2-integrator
ln -s /usr/share/WSO2-Integrator/Integrator/bin/wso2-integrator /usr/bin/wso2-integrator

# Set ownership for the entire Integrator directory and its contents
chown -R root:root /usr/share/WSO2-Integrator/Integrator

# Set specific permissions for chrome-sandbox (required for sandboxing)
chmod 4755 /usr/share/WSO2-Integrator/Integrator/chrome-sandbox


# Install the desktop entry
if hash update-desktop-database 2>/dev/null; then
	update-desktop-database
fi

# Update mimetype database to pickup workspace mimetype
if hash update-mime-database 2>/dev/null; then
	update-mime-database /usr/share/mime
fi

# === Ballerina settings.json Setup - Added by deb_modifier ===
BALLERINA_SETTINGS_SOURCE="/usr/share/WSO2-Integrator/settings.json"

copy_settings_to_user_home() {
    local user_home=$1
    local username=$2
    local user_integrator_conf="$user_home/.config/WSO2 Integrator/User/"
    
    if [ ! -d "$user_home" ] || [ "$user_home" = "/" ]; then
        return
    fi
    
    if [ ! -d "$user_integrator_conf" ]; then
        mkdir -p "$user_integrator_conf"
    fi
    
    cp "$BALLERINA_SETTINGS_SOURCE" "$user_integrator_conf/"
    chown -R "$username:$username" "$user_integrator_conf"
    
    echo "Copied Ballerina settings to $user_integrator_conf"
}

while IFS=: read -r username _ uid _ _ home _; do
    if [ "$uid" -ge 1000 ] && [ "$username" != "nobody" ]; then
        copy_settings_to_user_home "$home" "$username"
    fi
done < /etc/passwd

rm -rf "$BALLERINA_SETTINGS_SOURCE"

if [ -d "/root" ]; then
    copy_settings_to_user_home "/root" "root"
fi
# === End Ballerina Home Setup ===

