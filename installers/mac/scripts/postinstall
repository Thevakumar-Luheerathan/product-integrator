#!/bin/bash

# Get the user who invoked the installer
CURRENT_USER="${USER}"
if [ -z "$CURRENT_USER" ]; then
    CURRENT_USER="$(whoami)"
fi

USER_HOME=$(eval echo ~$CURRENT_USER)
USER_HOME_TEMP="$USER_HOME/private/tmp"
USER_APPS="$USER_HOME/Applications"
USER_APP_SUPPORT_DIR="$USER_HOME/Library/Application Support/WSO2 Integrator"
USER_APP_SETTINGS="$USER_APP_SUPPORT_DIR/User/settings.json"

# Create user Applications directory if it doesn't exist
mkdir -p "$USER_APPS"
mkdir -p "$USER_APP_SUPPORT_DIR"

# Copy the app to user's Applications folder
if [ -d "$USER_HOME_TEMP" ]; then
    echo "Installing to $USER_APPS..."
    cp -R "$USER_HOME_TEMP/Applications/WSO2 Integrator.app" "$USER_APPS/"
    chown -R "$CURRENT_USER" "$USER_APPS/WSO2 Integrator.app"
    xattr -r -d com.apple.quarantine "$USER_APPS/WSO2 Integrator.app"

    # Copy the ballerina-home directory
    chmod -R 755 "$USER_HOME_TEMP/ballerina-home/bin/"*
    chmod -R 755 "$USER_HOME_TEMP/ballerina-home/scripts/"* #TODO: Need to check why bin has permissions but scripts don't
    cp -R "$USER_HOME_TEMP/ballerina-home" "$USER_APP_SUPPORT_DIR/"
    chown -R "$CURRENT_USER" "$USER_APP_SUPPORT_DIR/"
    # chmod -R 755 "$USER_APP_SUPPORT_DIR/ballerina-home/bin/"*
    # chmod -R 755 "$USER_APP_SUPPORT_DIR/ballerina-home/scripts/"* 

    # Clean up temp directory
    rm -rf "$USER_HOME_TEMP"
    
    echo "Installation completed successfully!"
else
    echo "Error: Application not found in temporary location"
    exit 1
fi

    cat "$USER_APP_SETTINGS"

    # Update settings.json with ballerina.home and ballerina.pluginDevMode using standard tools
    if [ -f "$USER_APP_SETTINGS" ]; then
        tmpfile=$(mktemp)
        # Remove last closing brace, add new keys, and close again
        sed '$d' "$USER_APP_SETTINGS" > "$tmpfile"
        echo "  ,\"ballerina.home\": \"$USER_APP_SUPPORT_DIR/ballerina-home\",\n  \"ballerina.pluginDevMode\": true\n}" >> "$tmpfile"
        mv "$tmpfile" "$USER_APP_SETTINGS"
    else
        echo "settings.json not found, creating a new one at $USER_APP_SETTINGS"
        mkdir -p "$(dirname "$USER_APP_SETTINGS")"
        cat > "$USER_APP_SETTINGS" <<EOF
{
    "ballerina.home": "$USER_APP_SUPPORT_DIR/ballerina-home",
    "ballerina.pluginDevMode": true
}
EOF
fi

exit 0
